name: Create SDK Snapshot

on:
  pull_request:
    branches: ['master']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 🤘 Checkout
        uses: actions/checkout@v4
        with:
          path: sdk

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: 🔐 Authenticate with NPM
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
        working-directory: sdk

      - name: 🧩 Install dependencies
        run: npm ci --ignore-scripts
        working-directory: sdk

      - name: 🖊️ Bump version
        run: npm run changeset:snapshot -- --pr $PR --sha $COMMIT_SHA
        working-directory: sdk
        env:
          PR: ${{ github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}

      - name: 🛠️ Build SDK
        run: npm run build
        working-directory: sdk

      - name: 🚀 Publish snapshot
        run: npm run changeset -- publish --no-git-tag --snapshot --tag beta
        working-directory: sdk

      - name: Check for package updates
        run: |
          PACKAGE_NAME="@galacticcouncil/sdk"
          CURRENT_VERSION="$(grep $PACKAGE_NAME package.json | cut -d '"' -f4)"
          LATEST_VERSION="$(npm view $PACKAGE_NAME versions --json | jq -r '.[-1]')"
          echo "PACKAGE_NAME: $PACKAGE_NAME"
          echo "Current version: $CURRENT_VERSION"
          echo "Latest version: $LATEST_VERSION"
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "UPDATE_AVAILABLE=true" >> $GITHUB_ENV
            echo "NEW_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
            echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          fi
        working-directory: sdk

      - name: Checkout hydration-ui repository
        if: env.UPDATE_AVAILABLE == 'true'
        uses: actions/checkout@v4
        with:
          path: ui
          repository: 'galacticcouncil/hydration-ui'
          token: ${{ secrets.TARGET_REPO_PAT }}

      - name: Update package.json in target repository
        if: env.UPDATE_AVAILABLE == 'true'
        run: |
          yarn add ${{ env.PACKAGE_NAME }}@${{ env.NEW_VERSION }}
          git add package.json package-lock.json
          git commit -m "Update ${{ env.PACKAGE_NAME }} to version ${{ env.NEW_VERSION }}"
        working-directory: ui

      - name: Create Pull Request in target repository
        if: env.UPDATE_AVAILABLE == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.TARGET_REPO_PAT }}
          commit-message: 'Update ${{ env.PACKAGE_NAME }} to version ${{ env.NEW_VERSION }}'
          title: 'Update ${{ env.PACKAGE_NAME }} to version ${{ env.NEW_VERSION }}'
          body: |
            This PR updates ${{ env.PACKAGE_NAME }} to the latest version ${{ env.NEW_VERSION }}.

            Current version: ${{ env.CURRENT_VERSION }}
            New version: ${{ env.NEW_VERSION }}
          branch: update-sdk-${{ env.NEW_VERSION }}
          base: main
          path: 'hydration-ui'
